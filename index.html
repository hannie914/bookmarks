<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>트윗 보관함 — 가벼운 모드(수동/지연 임베드) + 자동저장</title>
<script async src="https://platform.twitter.com/widgets.js"></script>
<style>
  :root { --bg:#fff; --fg:#1b1f23; --muted:#6a737d; --card:#fff; --border:#eaecef; --chip:#f1f8ff; --chip-fg:#0366d6; --accent:#0366d6; }
  [data-theme="dark"] { --bg:#0d1117; --fg:#c9d1d9; --muted:#8b949e; --card:#161b22; --border:#30363d; --chip:#13233a; --chip-fg:#58a6ff; --accent:#58a6ff; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;z-index:20;backdrop-filter:blur(8px);background:color-mix(in oklab,var(--bg) 92%,transparent);border-bottom:1px solid var(--border)}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:860px){.row{grid-template-columns:1fr}}
  h1{margin:0 0 8px;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  textarea,input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg)}
  button{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);cursor:pointer}
  button:hover{filter:brightness(1.03)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .switch{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .count{margin-left:auto}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:var(--chip);color:var(--chip-fg);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
  .chip.active{outline:2px solid var(--chip-fg)}
  main .wrap{padding-top:8px}
  #grid{display:grid;gap:16px;margin:16px 0 40px;grid-template-columns:repeat(auto-fill,minmax(360px,1fr))}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--card);padding:12px;display:flex;flex-direction:column;gap:8px}
  .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:12px;color:var(--muted)}
  .line{display:flex;gap:8px;align-items:center}
  .line input{flex:1}
  .footer{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .link{font-size:12px;color:var(--muted);text-decoration:none;word-break:break-all}
  .kbd{border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-family:ui-monospace,monospace}
  [data-theme="dark"] .twitter-tweet-rendered{filter:brightness(0.92)}
  .pagingbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;margin-top:8px}
  .pagingbar .muted{white-space:nowrap}
  .placeholder{border:1px dashed var(--border);border-radius:12px;padding:10px;text-align:center;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>트윗 보관함 <span class="sub">가벼운 모드(수동/지연 임베드) + 자동저장</span></h1>
    <div class="row">
      <div>
        <div class="sub">한 줄에 하나씩 <b>트윗 URL</b>. 같은 줄에 <code>#태그</code>와 <code>| 메모</code>도 가능. 아래 “공통 태그”는 이번 추가분 전체에 붙습니다.</div>
        <textarea id="bulk" placeholder="예)
https://twitter.com/nasa/status/123... #우주 #사진 | 허블 텍스트
https://x.com/someone/status/456... #정책 | 개인 메모"></textarea>
        <div class="controls" style="margin-top:8px">
          <input id="commonTags" placeholder="공통 태그 (예: #읽을거리 #디자인)" />
          <button id="importBtn">가져오기</button>
          <button id="clearInput">입력창 비우기</button>
          <button id="syncSettings">동기화 설정</button>
          <span class="sub">중복 URL은 자동 건너뜁니다.</span>
        </div>
        <div class="controls" style="margin-top:6px">
          <label class="switch"><input type="checkbox" id="autoEmbedToggle" /> 자동 임베드(화면 진입 시)</label>
          <button id="embedAll">현재 페이지 전체 임베드</button>
          <span class="sub">기본: 수동 임베드(가벼움)</span>
        </div>
      </div>
      <div>
        <div class="sub">검색( URL / #태그 / 메모 )</div>
        <input id="q" placeholder="#우주 또는 메모 단어 등" />
        <div class="controls" style="margin-top:8px">
          <label class="switch"><input type="checkbox" id="darkToggle" /> 다크모드</label>
          <span class="count sub" id="count"></span>
        </div>
        <div class="controls" style="margin-top:6px">
          <button id="cloudPull">클라우드에서 불러오기</button>
          <button id="cloudPush">클라우드로 업로드</button>
          <button id="exportBtn">백업 내보내기(JSON)</button>
          <button id="importJsonBtn">백업 불러오기</button>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
        </div>
        <div class="controls" style="margin-top:6px">
          <div class="sub">표시 개수</div>
          <select id="pageSize">
            <option>6</option><option>9</option><option selected>12</option><option>18</option><option>24</option><option>36</option>
          </select>
          <div class="pagingbar">
            <button id="firstPage">처음</button>
            <button id="prevPage">이전</button>
            <button id="nextPage">다음</button>
            <button id="lastPage">마지막</button>
            <span class="sub" id="pageInfo"></span>
          </div>
        </div>
        <div class="sub" style="margin-top:6px">
          <span class="kbd">Tip</span> 태그 칩 클릭 → 해당 태그만 보기. <b>‘태그 없음’</b> 칩으로 무태그만 보기.
        </div>
      </div>
    </div>
    <div id="tagChips" class="chips"></div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="grid"></div>
  </div>
</main>

<!-- 설정 모달 -->
<div class="modal-backdrop" id="modalWrap" style="display:none">
  <div class="modal">
    <h2>동기화 설정</h2>
    <div class="desc">GitHub 토큰(권한: gist read/write)과 비공개 Gist의 ID를 입력하세요. 이 값들은 이 브라우저에만 저장됩니다.</div>
    <div class="row">
      <div><label class="sub">GitHub Personal Access Token</label><input id="tokenInput" placeholder="ghp_... 또는 fine-grained token" /></div>
      <div><label class="sub">Gist ID</label><input id="gistInput" placeholder="예: abcdef1234567890..." /></div>
      <div class="controls" style="margin-top:10px">
        <button id="saveSettings" style="border-color:var(--accent);color:var(--accent)">저장</button>
        <button id="closeSettings">닫기</button>
        <span class="sub" id="settingsStatus"></span>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 유틸 ===== */
const $ = (s,d=document)=>d.querySelector(s);
const $$ = (s,d=document)=>Array.from(d.querySelectorAll(s));
const LS_KEY='tweet-shelf-v5';           // 버전 올림(기존 localStorage와 충돌 없음)
const CFG_TOKEN='tweet-shelf-token';
const CFG_GIST ='tweet-shelf-gist';
const LS_PAGE_SIZE='tweet-shelf-pageSize';
const LS_AUTO_EMBED='tweet-shelf-autoEmbed';
const UNTAGGED='__UNTAGGED__';

const debounce=(fn,ms=600)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
const normalize=(url)=>{try{const u=new URL(url.trim());if(u.hostname==='x.com')u.hostname='twitter.com';return u.toString()}catch{return url.trim()}};
const parseLine=(line)=>{
  const urlMatch=line.match(/https?:\/\/(twitter\.com|x\.com)\/\S+/i); if(!urlMatch) return null;
  const url=normalize(urlMatch[0]);
  const tags=(line.match(/#[^\s#|]+/g)||[]).map(s=>s.toLowerCase());
  const note=line.includes('|')?line.split('|').slice(1).join('|').trim():'';
  return { url, tags, note };
};
const loadLocal=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{return[]}};
const saveLocal=(arr)=>localStorage.setItem(LS_KEY, JSON.stringify(arr));

/* ===== 상태 ===== */
const state={
  items: loadLocal(),
  theme: localStorage.getItem('theme') || 'light',
  token: localStorage.getItem(CFG_TOKEN) || '',
  gistId: localStorage.getItem(CFG_GIST) || '',
  activeTag: null, // null|tag|UNTAGGED
  page: 1,
  pageSize: +(localStorage.getItem(LS_PAGE_SIZE) || 12),
  autoEmbed: localStorage.getItem(LS_AUTO_EMBED)==='1', // 기본 false(가벼움)
  filteredCache: [],
  io: null  // IntersectionObserver
};

/* ===== 테마 ===== */
function applyTheme(){ document.documentElement.setAttribute('data-theme', state.theme); $('#darkToggle').checked = state.theme==='dark'; }

/* ===== 태그 칩 ===== */
function uniqueTags(){ const set=new Set(); state.items.forEach(it=>(it.tags||[]).forEach(t=>set.add(t))); return Array.from(set).sort((a,b)=>a.localeCompare(b)); }
function renderTagChips(){
  const box=$('#tagChips'); if(!box) return; box.innerHTML='';
  const mk=(label,active,click)=>{const b=document.createElement('button'); b.className='chip'+(active?' active':''); b.textContent=label; b.addEventListener('click',click); box.appendChild(b);};
  mk('전체', !state.activeTag, ()=>{state.activeTag=null; state.page=1; render()});
  mk('태그 없음', state.activeTag===UNTAGGED, ()=>{state.activeTag=(state.activeTag===UNTAGGED?null:UNTAGGED); state.page=1; render()});
  uniqueTags().forEach(tag=> mk(tag, state.activeTag===tag, ()=>{state.activeTag=(state.activeTag===tag?null:tag); state.page=1; render()}));
}

/* ===== 필터/페이지 ===== */
function currentFiltered(){
  const q=($('#q')?.value||'').toLowerCase().trim();
  const active=state.activeTag;
  return state.items.filter(it=>{
    const tagText=(it.tags||[]).join(' ');
    const note=it.note||'';
    const hay=[it.url, tagText, note].join(' ').toLowerCase();
    const qok=!q||hay.includes(q);
    let tok=true;
    if(active===UNTAGGED) tok=(it.tags||[]).length===0;
    else if(active) tok=(it.tags||[]).map(t=>t.toLowerCase()).includes(active);
    return qok && tok;
  });
}
function pageSlice(arr){
  const total=arr.length, totalPages=Math.max(1, Math.ceil(total/state.pageSize));
  if(state.page>totalPages) state.page=totalPages;
  const start=(state.page-1)*state.pageSize, end=Math.min(start+state.pageSize,total);
  return {total,totalPages,start,end,slice:arr.slice(start,end)};
}

/* ===== 임베드 제어 ===== */
function tweetIdFromUrl(url){ const m=url.match(/status\/(\d+)/); return m?m[1]:null; }
function ensureEmbed(card){
  // 이미 렌더됨?
  if (card.dataset.embedded==='1') return;
  const url=card.dataset.url;
  const id=tweetIdFromUrl(url);
  const mount=card.querySelector('.embed');
  if(!mount) return;
  mount.innerHTML=''; // 비움
  if(window.twttr && window.twttr.widgets && id){
    window.twttr.widgets.createTweet(id, mount);
    card.dataset.embedded='1';
  } else {
    // fallback: blockquote + load
    mount.innerHTML=`<blockquote class="twitter-tweet"><a href="${url}"></a></blockquote>`;
    if(window.twttr&&window.twttr.widgets) window.twttr.widgets.load(mount);
    card.dataset.embedded='1';
  }
}
function clearEmbed(card){
  const mount=card.querySelector('.embed');
  if(mount){ mount.innerHTML=`<div class="placeholder">임베드 안 함 · [보기]를 눌러 표시</div>`; }
  card.dataset.embedded='0';
}

/* ===== 카드 UI ===== */
function cardHTML(item, idx){
  const tagText=(item.tags||[]).join(' ');
  // 기본은 임베드 안 함(가벼움)
  const placeholder = `<div class="placeholder">임베드 안 함 · [보기]를 눌러 표시</div>`;
  return `
    <article class="card" data-idx="${idx}" data-url="${item.url}" data-tags="${tagText}" data-note="${item.note||''}" data-embedded="0">
      <div class="meta"><span>${tagText || '태그 없음'}</span>${item.note?`<span>· ${item.note}</span>`:''}</div>
      <div class="embed">${placeholder}</div>
      <div class="line">
        <input class="tags" placeholder="#태그 공백구분" value="${tagText}" />
        <button class="view">보기</button>
      </div>
      <div class="line">
        <input class="note" placeholder="메모" value="${item.note||''}" />
      </div>
      <div class="footer">
        <a class="link" href="${item.url}" target="_blank" rel="noopener">${item.url}</a>
        <div class="actions">
          <button class="del">삭제</button>
        </div>
      </div>
    </article>`;
}

/* ===== 렌더(가벼운 방식) ===== */
function render(){
  const filtered=currentFiltered();
  state.filteredCache=filtered;
  const { total,totalPages,start,end,slice } = pageSlice(filtered);

  const grid=$('#grid');
  grid.innerHTML = slice.map((it,i)=>cardHTML(it, i+start)).join('');
  $('#count').textContent=`총 ${total}개`;
  $('#pageInfo').textContent = total ? `· ${state.page}/${totalPages} · ${start+1}–${end}` : '';

  renderTagChips();

  // 카드 이벤트: 보기/삭제/자동저장
  $$('.card').forEach(card=>{
    // 보기(수동 임베드)
    card.querySelector('.view').addEventListener('click', ()=> ensureEmbed(card));
    // 삭제(부분 갱신)
    card.querySelector('.del').addEventListener('click', ()=>{
      const idx=+card.dataset.idx;
      if(!confirm('이 카드를 삭제할까요?')) return;
      state.items.splice(idx,1);
      saveLocal(state.items);
      // 현재 페이지만 다시 렌더(빠름)
      const { totalPages } = pageSlice(currentFiltered());
      if(state.page>totalPages) state.page=totalPages;
      render();
    });

    // 자동 저장(디바운스)
    const idx=+card.dataset.idx;
    const tagsInput=card.querySelector('.tags');
    const noteInput=card.querySelector('.note');
    const doSave=debounce(()=>{
      const tags=tagsInput.value.trim().split(/\s+/).filter(Boolean);
      const note=noteInput.value.trim();
      state.items[idx].tags=tags.map(s=>s.startsWith('#')?s.toLowerCase():'#'+s.toLowerCase());
      state.items[idx].note=note;
      saveLocal(state.items);
      // 상단 메타 텍스트만 부분 갱신
      card.dataset.tags=(state.items[idx].tags||[]).join(' ');
      card.dataset.note=note;
      card.querySelector('.meta').innerHTML=`<span>${card.dataset.tags || '태그 없음'}</span>${note?`<span>· ${note}</span>`:''}`;
    }, 600);
    tagsInput.addEventListener('input', doSave);
    noteInput.addEventListener('input', doSave);
  });

  // 자동 임베드 모드면, 가시영역 들어온 카드만 임베드
  setupObserver();
}

/* ===== IntersectionObserver로 자동 임베드 ===== */
function setupObserver(){
  // 해제
  if(state.io){ state.io.disconnect(); state.io=null; }
  if(!state.autoEmbed) return;

  state.io = new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting){
        const card=entry.target;
        ensureEmbed(card);
        state.io.unobserve(card);
      }
    });
  }, { root:null, rootMargin:'200px', threshold:0.01 });

  $$('.card').forEach(card=> state.io.observe(card));
}

/* ===== 초기화 & 핸들러 ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // 테마
  applyTheme();
  $('#darkToggle').addEventListener('change', e=>{ state.theme=e.target.checked?'dark':'light'; localStorage.setItem('theme',state.theme); applyTheme(); });

  // 자동 임베드 스위치
  $('#autoEmbedToggle').checked = state.autoEmbed;
  $('#autoEmbedToggle').addEventListener('change', e=>{
    state.autoEmbed = !!e.target.checked;
    localStorage.setItem(LS_AUTO_EMBED, state.autoEmbed ? '1' : '0');
    render();
  });
  $('#embedAll').addEventListener('click', ()=> $$('.card').forEach(ensureEmbed));

  // 페이지 크기/페이지 버튼
  $('#pageSize').value=String(state.pageSize);
  $('#pageSize').addEventListener('change', e=>{ state.pageSize=+e.target.value; localStorage.setItem(LS_PAGE_SIZE,String(state.pageSize)); state.page=1; render(); });
  $('#firstPage').addEventListener('click', ()=>{ state.page=1; render(); });
  $('#prevPage').addEventListener('click', ()=>{ state.page=Math.max(1,state.page-1); render(); });
  $('#nextPage').addEventListener('click', ()=>{
    const { totalPages } = pageSlice(state.filteredCache.length?state.filteredCache:currentFiltered());
    state.page=Math.min(totalPages,state.page+1); render();
  });
  $('#lastPage').addEventListener('click', ()=>{
    const { totalPages } = pageSlice(state.filteredCache.length?state.filteredCache:currentFiltered());
    state.page=totalPages; render();
  });

  // 검색
  $('#q').addEventListener('input', ()=>{ state.page=1; render(); });

  // 가져오기 (공통 태그 포함)
  $('#importBtn').addEventListener('click', ()=>{
    const lines=$('#bulk').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const common=($('#commonTags').value||'').trim().split(/\s+/).filter(Boolean).map(t=>t.startsWith('#')?t.toLowerCase():'#'+t.toLowerCase());
    const newOnes=[];
    for(const line of lines){
      const p=parseLine(line); if(!p) continue;
      if(state.items.some(x=>x.url===p.url)) continue;
      if(common.length) p.tags=[...new Set([...(p.tags||[]), ...common])];
      newOnes.push(p);
    }
    if(!newOnes.length){ alert('추가할 URL이 없습니다.'); return; }
    state.items=[...newOnes, ...state.items];
    saveLocal(state.items);
    $('#bulk').value=''; // 입력창 비우기
    state.page=1;
    render();
  });
  $('#clearInput').addEventListener('click', ()=> $('#bulk').value='');

  // 백업/복원
  $('#exportBtn').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state.items,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tweet-shelf-backup.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#importJsonBtn').addEventListener('click', ()=> $('#fileInput').click());
  $('#fileInput').addEventListener('change', (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const arr=JSON.parse(r.result); if(!Array.isArray(arr)) throw new Error();
        const cleaned=arr.filter(x=>x && typeof x.url==='string').map(x=>({ url:normalize(x.url), tags:Array.isArray(x.tags)?x.tags.map(t=>t.toLowerCase()):[], note: typeof x.note==='string'?x.note:'' }));
        state.items=cleaned; saveLocal(state.items); state.page=1; render();
      }catch{ alert('JSON 형식이 올바르지 않습니다.'); }
    };
    r.readAsText(f,'utf-8'); e.target.value='';
  });

  // 동기화(Gist)
  async function cloudPull(){
    if(!state.token || !state.gistId){ alert('동기화 설정이 비어있습니다.'); return; }
    const res=await fetch(`https://api.github.com/gists/${state.gistId}`,{headers:{'Authorization':`Bearer ${state.token}`,'Accept':'application/vnd.github+json'}});
    if(!res.ok){ alert('불러오기 실패: Gist ID/토큰 확인'); return; }
    const data=await res.json();
    const file=Object.values(data.files||{}).find(f=>/tweet-shelf\.json$/i.test(f.filename));
    if(!file){ alert('Gist에 tweet-shelf.json 파일이 없습니다.'); return; }
    try{
      const arr=JSON.parse(file.content); if(!Array.isArray(arr)) throw new Error();
      const map=new Map();
      arr.forEach(x=>map.set(x.url,{url:normalize(x.url),tags:(x.tags||[]).map(t=>t.toLowerCase()),note:x.note||''}));
      state.items.forEach(x=>{ if(!map.has(x.url)) map.set(x.url,x); });
      state.items=Array.from(map.values());
      saveLocal(state.items);
      state.page=1; render();
      alert('클라우드에서 불러왔습니다.');
    }catch{ alert('Gist JSON 파싱 실패'); }
  }
  async function cloudPush(){
    if(!state.token || !state.gistId){ alert('동기화 설정이 비어있습니다.'); return; }
    const body={files:{'tweet-shelf.json':{content:JSON.stringify(state.items,null,2)}}};
    const res=await fetch(`https://api.github.com/gists/${state.gistId}`,{method:'PATCH',headers:{'Authorization':`Bearer ${state.token}`,'Accept':'application/vnd.github+json','Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!res.ok){ alert('업로드 실패: Gist ID/토큰/권한 확인'); return; }
    alert('클라우드로 업로드했습니다.');
  }
  $('#cloudPull').addEventListener('click', cloudPull);
  $('#cloudPush').addEventListener('click', cloudPush);

  // 모달
  function openSettings(){ $('#tokenInput').value=state.token||''; $('#gistInput').value=state.gistId||''; $('#settingsStatus').textContent=''; $('#modalWrap').style.display='flex'; }
  function closeSettings(){ $('#modalWrap').style.display='none'; }
  function saveSettings(){ state.token=$('#tokenInput').value.trim(); state.gistId=$('#gistInput').value.trim(); localStorage.setItem(CFG_TOKEN,state.token); localStorage.setItem(CFG_GIST,state.gistId); $('#settingsStatus').textContent='저장됨'; setTimeout(closeSettings, 300); }
  $('#syncSettings').addEventListener('click', openSettings);
  $('#closeSettings').addEventListener('click', closeSettings);
  $('#saveSettings').addEventListener('click', saveSettings);
  document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='modalWrap') closeSettings(); });

  // 첫 렌더
  applyTheme();
  render();
});
</script>
</body>
</html>
