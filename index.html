<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>트윗 보관함 — 미리보기 + 검색/태그 + 동기화</title>
<script async src="https://platform.twitter.com/widgets.js"></script>
<style>
  :root {
    --bg:#fff; --fg:#1b1f23; --muted:#6a737d; --card:#fff; --border:#eaecef; --chip:#f1f8ff; --chip-fg:#0366d6;
    --accent:#0366d6;
  }
  [data-theme="dark"] {
    --bg:#0d1117; --fg:#c9d1d9; --muted:#8b949e; --card:#161b22; --border:#30363d; --chip:#13233a; --chip-fg:#58a6ff;
    --accent:#58a6ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;z-index:20;backdrop-filter:blur(8px);background:color-mix(in oklab,var(--bg) 92%,transparent);border-bottom:1px solid var(--border)}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:860px){.row{grid-template-columns:1fr}}
  h1{margin:0 0 8px;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  textarea,input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg)}
  button{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);cursor:pointer}
  button:hover{filter:brightness(1.03)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .count{margin-left:auto}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:var(--chip);color:var(--chip-fg);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
  .chip.active{outline:2px solid var(--chip-fg)}
  main .wrap{padding-top:8px}
  #grid{display:grid;gap:16px;margin:16px 0 40px;grid-template-columns:repeat(auto-fill,minmax(360px,1fr))}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--card);padding:12px;display:flex;flex-direction:column;gap:8px}
  .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:12px;color:var(--muted)}
  .line{display:flex;gap:8px;align-items:center}
  .line input{flex:1}
  .footer{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .link{font-size:12px;color:var(--muted);text-decoration:none;word-break:break-all}
  .switch{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .kbd{border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-family:ui-monospace,monospace}
  [data-theme="dark"] .twitter-tweet-rendered{filter:brightness(0.92)}

  /* 설정 모달 */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:var(--card);border:1px solid var(--border);border-radius:12px;max-width:520px;width:92%;padding:16px}
  .modal h2{margin:0 0 8px;font-size:16px}
  .modal .desc{font-size:12px;color:var(--muted);margin-bottom:8px}
  .modal .row{grid-template-columns:1fr}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>트윗 보관함 <span class="sub">미리보기 + 검색/태그 + <b>클라우드 동기화</b></span></h1>
    <div class="row">
      <div>
        <div class="sub">한 줄에 하나씩 <b>트윗 URL</b>. 같은 줄에 <code>#태그</code>와 <code>| 메모</code>를 적어도 됩니다.</div>
        <textarea id="bulk" placeholder="예)
https://twitter.com/nasa/status/123... #우주 #사진 | 허블 텍스트
https://x.com/someone/status/456... #정책 | 개인 메모"></textarea>
        <div class="controls" style="margin-top:8px">
          <button id="importBtn">가져오기</button>
          <button id="clearInput">입력창 비우기</button>
          <button id="syncSettings">동기화 설정</button>
          <span class="sub">중복 URL은 자동 건너뜁니다.</span>
        </div>
      </div>
      <div>
        <div class="sub">검색( URL / #태그 / 메모 )</div>
        <input id="q" placeholder="#우주 또는 메모 단어 등" />
        <div class="controls" style="margin-top:8px">
          <div class="switch">
            <input type="checkbox" id="darkToggle" />
            <label for="darkToggle">다크모드</label>
          </div>
          <span class="count sub" id="count"></span>
        </div>
        <div class="controls" style="margin-top:6px">
          <button id="cloudPull">클라우드에서 불러오기</button>
          <button id="cloudPush">클라우드로 업로드</button>
          <button id="exportBtn">백업 내보내기(JSON)</button>
          <button id="importJsonBtn">백업 불러오기</button>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
        </div>
        <div class="sub" style="margin-top:6px">
          <span class="kbd">Tip</span> 태그 칩 클릭 → 해당 태그만 보기
        </div>
      </div>
    </div>
    <div id="tagChips" class="chips"></div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="grid"></div>
  </div>
</main>

<!-- 설정 모달 -->
<div class="modal-backdrop" id="modalWrap">
  <div class="modal">
    <h2>동기화 설정</h2>
    <div class="desc">GitHub에서 <b>gist: read & write</b> 권한 토큰을 만들고, 비공개 Gist의 <b>ID</b>를 넣어 주세요. 입력값은 이 브라우저에만 저장됩니다.</div>
    <div class="row">
      <div>
        <label class="sub">GitHub Personal Access Token</label>
        <input id="tokenInput" placeholder="ghp_... 또는 fine-grained token" />
      </div>
      <div>
        <label class="sub">Gist ID</label>
        <input id="gistInput" placeholder="예: abcdef1234567890..." />
      </div>
      <div class="controls" style="margin-top:10px">
        <button id="saveSettings" style="border-color:var(--accent);color:var(--accent)">저장</button>
        <button id="closeSettings">닫기</button>
        <span class="sub" id="settingsStatus"></span>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (s,d=document)=>d.querySelector(s);
  const $$ = (s,d=document)=>Array.from(d.querySelectorAll(s));
  const LS_KEY = 'tweet-shelf-v3';
  const CFG_TOKEN = 'tweet-shelf-token';
  const CFG_GIST = 'tweet-shelf-gist';

  const normalize = (url) => {
    try { const u = new URL(url.trim()); if (u.hostname==='x.com') u.hostname='twitter.com'; return u.toString(); }
    catch { return url.trim(); }
  };
  const parseLine = (line) => {
    const urlMatch = line.match(/https?:\/\/(twitter\.com|x\.com)\/\S+/i);
    if (!urlMatch) return null;
    const url = normalize(urlMatch[0]);
    const tags = (line.match(/#[^\s#|]+/g)||[]).map(s=>s.toLowerCase());
    const note = line.includes('|') ? line.split('|').slice(1).join('|').trim() : '';
    return { url, tags, note };
  };

  const loadLocal = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); } catch { return []; } };
  const saveLocal = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));

  const state = {
    items: loadLocal(),
    theme: localStorage.getItem('theme') || 'light',
    activeTag: null,
    token: localStorage.getItem(CFG_TOKEN) || '',
    gistId: localStorage.getItem(CFG_GIST) || ''
  };

  // THEME
  const applyTheme = () => { document.documentElement.setAttribute('data-theme', state.theme); $('#darkToggle').checked = state.theme==='dark'; };
  $('#darkToggle').addEventListener('change', (e)=>{ state.theme = e.target.checked ? 'dark' : 'light'; localStorage.setItem('theme', state.theme); applyTheme(); });
  applyTheme();

  // RENDER helpers
  const renderCount = () => $('#count').textContent = `${state.items.length}개 저장됨`;
  const uniqueTags = () => { const set=new Set(); state.items.forEach(it => (it.tags||[]).forEach(t=>set.add(t))); return Array.from(set).sort((a,b)=>a.localeCompare(b)); };
  const renderTagChips = () => {
    const chips = uniqueTags();
    const box = $('#tagChips'); box.innerHTML = '';
    if (!chips.length) return;
    const all = document.createElement('button');
    all.className = 'chip' + (!state.activeTag ? ' active' : '');
    all.textContent = '전체';
    all.addEventListener('click', ()=>{ state.activeTag = null; filterAndRender(); });
    box.appendChild(all);
    chips.forEach(tag => {
      const el = document.createElement('button');
      el.className = 'chip' + (state.activeTag===tag ? ' active' : '');
      el.textContent = tag;
      el.addEventListener('click', ()=>{ state.activeTag = (state.activeTag===tag?null:tag); filterAndRender(); });
      box.appendChild(el);
    });
  };
  const cardHTML = (item, idx) => {
    const tagText = (item.tags||[]).join(' ');
    return `
      <article class="card" data-idx="${idx}" data-url="${item.url}" data-tags="${tagText}" data-note="${item.note||''}">
        <div class="meta"><span>${tagText || '태그 없음'}</span>${item.note?`<span>· ${item.note}</span>`:''}</div>
        <div class="embed"><blockquote class="twitter-tweet"><a href="${item.url}"></a></blockquote></div>
        <div class="line"><input class="tags" placeholder="#태그 공백구분" value="${tagText}" /></div>
        <div class="line"><input class="note" placeholder="메모" value="${item.note||''}" /></div>
        <div class="footer">
          <a class="link" href="${item.url}" target="_blank" rel="noopener">${item.url}</a>
          <div class="actions">
            <button class="save">저장</button>
            <button class="del">삭제</button>
          </div>
        </div>
      </article>`;
  };
  const render = () => {
    $('#grid').innerHTML = state.items.map((it,i)=>cardHTML(it,i)).join('');
    const loadWidgets = ()=> (window.twttr && window.twttr.widgets) ? window.twttr.widgets.load($('#grid')) : setTimeout(loadWidgets, 200);
    loadWidgets();
    renderCount(); renderTagChips();
    $$('.card').forEach(card=>{
      card.querySelector('.save').addEventListener('click', ()=>{
        const idx=+card.dataset.idx;
        const tags=card.querySelector('.tags').value.trim().split(/\s+/).filter(Boolean);
        const note=card.querySelector('.note').value.trim();
        state.items[idx].tags=tags.map(s=>s.startsWith('#')?s.toLowerCase():'#'+s.toLowerCase());
        state.items[idx].note=note;
        saveLocal(state.items);
        filterAndRender();
      });
      card.querySelector('.del').addEventListener('click', ()=>{
        const idx=+card.dataset.idx;
        if(!confirm('이 카드를 삭제할까요?')) return;
        state.items.splice(idx,1);
        saveLocal(state.items);
        filterAndRender();
      });
    });
  };
  const filterAndRender = () => {
    render();
    const q = ($('#q').value||'').toLowerCase().trim();
    const active = state.activeTag;
    $$('.card').forEach(c=>{
      const hay=[c.dataset.url,c.dataset.tags,c.dataset.note].join(' ').toLowerCase();
      const qok=!q||hay.includes(q);
      const tok=!active||(c.dataset.tags.toLowerCase().split(/\s+/).includes(active));
      c.style.display=(qok&&tok)?'':'none';
    });
    renderTagChips();
  };

  // INIT
  render();

  // 입력창 → 로컬 추가
  $('#importBtn').addEventListener('click', ()=>{
    const lines=$('#bulk').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const newOnes=[];
    for(const line of lines){
      const parsed=parseLine(line);
      if(!parsed) continue;
      if(state.items.some(x=>x.url===parsed.url)) continue;
      newOnes.push(parsed);
    }
    if(!newOnes.length){ alert('추가할 URL이 없습니다.'); return; }
    state.items=[...newOnes, ...state.items];
    saveLocal(state.items);
    $('#bulk').value='';
    filterAndRender();
  });
  $('#clearInput').addEventListener('click', ()=> $('#bulk').value='');
  $('#q').addEventListener('input', filterAndRender);

  // 백업/복원 (파일)
  $('#exportBtn').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state.items,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='tweet-shelf-backup.json'; a.click();
    URL.revokeObjectURL(url);
  });
  $('#importJsonBtn').addEventListener('click', ()=> $('#fileInput').click());
  $('#fileInput').addEventListener('change', (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const arr=JSON.parse(r.result);
        if(!Array.isArray(arr)) throw new Error('형식 오류');
        const cleaned=arr.filter(x=>x && typeof x.url==='string').map(x=>({
          url: normalize(x.url),
          tags: Array.isArray(x.tags)?x.tags.map(t=>t.toLowerCase()):[],
          note: typeof x.note==='string' ? x.note : ''
        }));
        state.items=cleaned; saveLocal(state.items); filterAndRender();
      }catch{ alert('JSON 형식이 올바르지 않습니다.'); }
    };
    r.readAsText(f,'utf-8'); e.target.value='';
  });

  // ====== GitHub Gist 동기화 ======
  const api = {
    async pull(){
      if(!state.token || !state.gistId){ alert('동기화 설정이 비어있습니다.'); return; }
      const res = await fetch(`https://api.github.com/gists/${state.gistId}`, {
        headers:{ 'Authorization':`Bearer ${state.token}`, 'Accept':'application/vnd.github+json' }
      });
      if(!res.ok){ alert('불러오기 실패: Gist ID/토큰 확인'); return; }
      const data = await res.json();
      const file = Object.values(data.files||{}).find(f=>/tweet-shelf\.json$/i.test(f.filename));
      if(!file){ alert('Gist에 tweet-shelf.json 파일이 없습니다.'); return; }
      try{
        const arr = JSON.parse(file.content);
        if(!Array.isArray(arr)) throw new Error();
        // 로컬과 병합(중복 URL 제거, 클라우드 우선)
        const map = new Map();
        arr.forEach(x=> map.set(x.url, {url:normalize(x.url), tags:(x.tags||[]).map(t=>t.toLowerCase()), note:x.note||''}));
        state.items.forEach(x=>{ if(!map.has(x.url)) map.set(x.url, x); });
        state.items = Array.from(map.values());
        saveLocal(state.items);
        filterAndRender();
        alert('클라우드에서 불러왔습니다.');
      }catch{ alert('Gist JSON 파싱 실패'); }
    },
    async push(){
      if(!state.token || !state.gistId){ alert('동기화 설정이 비어있습니다.'); return; }
      // 현재 state.items를 Gist에 업로드(덮어쓰기)
      const body = {
        files: {
          "tweet-shelf.json": {
            content: JSON.stringify(state.items, null, 2)
          }
        }
      };
      const res = await fetch(`https://api.github.com/gists/${state.gistId}`, {
        method:'PATCH',
        headers:{ 'Authorization':`Bearer ${state.token}`, 'Accept':'application/vnd.github+json', 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      if(!res.ok){ alert('업로드 실패: Gist ID/토큰/권한 확인'); return; }
      alert('클라우드로 업로드했습니다.');
    }
  };

  $('#cloudPull').addEventListener('click', api.pull);
  $('#cloudPush').addEventListener('click', api.push);

  // 설정 모달
  const openSettings = ()=> {
    $('#tokenInput').value = state.token;
    $('#gistInput').value = state.gistId;
    $('#settingsStatus').textContent = '';
    $('#modalWrap').style.display='flex';
  };
  const closeSettings = ()=> $('#modalWrap').style.display='none';

  $('#syncSettings').addEventListener('click', openSettings);
  $('#closeSettings').addEventListener('click', closeSettings);
  $('#modalWrap').addEventListener('click', (e)=>{ if(e.target.id==='modalWrap') closeSettings(); });

  $('#saveSettings').addEventListener('click', ()=>{
    state.token = $('#tokenInput').value.trim();
    state.gistId = $('#gistInput').value.trim();
    localStorage.setItem(CFG_TOKEN, state.token);
    localStorage.setItem(CFG_GIST, state.gistId);
    $('#settingsStatus').textContent = '저장됨';
    setTimeout(closeSettings, 400);
  });
})();
</script>
</body>
</html>
