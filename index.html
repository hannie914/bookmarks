<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>트윗 보관함 — 페이지 보기 + 자동접힘 헤더(오버레이) + 다중태그 + 동기화</title>

<!-- X(Twitter) 임베드 SDK -->
<script async src="https://platform.twitter.com/widgets.js"></script>

<style>
  :root { --bg:#fff; --fg:#1b1f23; --muted:#6a737d; --card:#fff; --border:#eaecef; --accent:#0366d6; }
  [data-theme="dark"] { --bg:#0d1117; --fg:#c9d1d9; --muted:#8b949e; --card:#161b22; --border:#30363d; --accent:#58a6ff; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--fg)}

  /* 헤더: 기본은 sticky 접힘, 필요 시 overlay로 고정 노출 */
  header{
    position: sticky;
    top: 0;
    z-index: 20;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    transition: max-height 180ms ease, opacity 120ms ease;
    will-change: max-height;
    overflow: hidden;
  }
  header.auto-hide{ max-height: var(--header-max, 600px); }
  header.auto-hide.hide{
    max-height: 0;
    border-bottom-color: transparent;
    pointer-events: none;
    opacity: 0;
  }
  /* 오버레이 모드: 스크롤 하단에서도 화면 위에 고정 노출 */
  header.overlay{
    position: fixed !important;
    top: 0; left: 0; right: 0;
    z-index: 9999;
    max-height: var(--header-max, 600px) !important;
    opacity: 1 !important;
    pointer-events: auto !important;
    box-shadow: 0 10px 24px rgba(0,0,0,.18);
  }
  @media (prefers-reduced-motion: reduce){ header{ transition:none } }

  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:860px){.row{grid-template-columns:1fr}}
  h1{margin:0 0 8px;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  textarea,input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg)}
  button{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);cursor:pointer}
  button:hover{filter:brightness(1.03)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .switch{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .count{margin-left:auto}

  #grid{display:grid;gap:16px;margin:16px 0 20px;grid-template-columns:repeat(auto-fill,minmax(360px,1fr))}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--card);padding:12px;display:flex;flex-direction:column;gap:8px}
  .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:12px;color:var(--muted)}
  .line{display:flex;gap:8px;align-items:center}
  .line input{flex:1}
  .footer{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .link{font-size:12px;color:var(--muted);text-decoration:none;word-break:break-all}
  .placeholder{border:1px dashed var(--border);border-radius:12px;padding:10px;text-align:center;font-size:12px;color:var(--muted)}
  [data-theme="dark"] .twitter-tweet-rendered{filter:brightness(0.92)}

  /* 모달 공통 */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:var(--card);border:1px solid var(--border);border-radius:12px;max-width:620px;width:92%;padding:16px}
  .modal h2{margin:0 0 8px;font-size:16px}
  .modal .desc{font-size:12px;color:var(--muted);margin-bottom:8px}
  .modal .row{display:grid;grid-template-columns:1fr;gap:10px}

  /* 태그 모달 리스트 */
  .tag-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .tag-list{max-height:340px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--card)}
  .tag-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;cursor:pointer;gap:8px}
  .tag-item:hover{background:rgba(0,0,0,.04)}
  [data-theme="dark"] .tag-item:hover{background:rgba(255,255,255,.06)}
  .tag-item > div{display:flex;align-items:center;gap:8px;min-width:0}
  .tag-name{
    display:block;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:100%;
  }
  .tag-count{font-size:12px;color:var(--muted)}
  .tag-item input{margin-right:4px}

  /* 우하단 '도구' 버튼 */
  .quick-toggle{
    position: fixed;
    right: 12px;
    bottom: 14px;
    z-index: 2147483647;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--fg);
    box-shadow: 0 4px 12px rgba(0,0,0,.12);
    cursor: pointer;
    font-size: 13px;
    pointer-events: auto;
  }
  .quick-toggle:hover{ filter: brightness(1.05); }
  .quick-toggle[aria-expanded="true"]{ outline: 2px solid var(--accent); }

  /* 페이지네이션 바 */
  .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pager .info{font-size:12px;color:var(--muted)}
  .pager button[disabled]{opacity:.5;cursor:not-allowed}

  @media (max-width:640px){
    .wrap{padding:8px 12px}
    h1{font-size:16px;margin-bottom:4px}
    .quick-toggle{ right:10px; bottom:10px; font-size:12px; padding:9px 11px }
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>트윗 보관함 <span class="sub">페이지 보기 / 더 보기 / 무한스크롤 + 자동저장 + 동기화</span></h1>

    <!-- 모드/임베드 제어 -->
    <div class="controls" style="margin:6px 0">
      <label class="switch"><input type="radio" name="mode" id="modePaginate" checked> 페이지</label>
      <label class="switch"><input type="radio" name="mode" id="modeLoadMore"> 더 보기</label>
      <label class="switch"><input type="radio" name="mode" id="modeInfinite"> 무한 스크롤</label>
      <label class="switch">동시에
        <input id="embedConcurrency" type="number" min="1" max="8" value="4" style="width:56px;margin:0 6px">개 임베드
      </label>
      <button id="embedAll">현재 표시분 임베드</button>
      <span id="embedStatus" class="sub"></span>
    </div>

    <div class="row">
      <!-- 좌: 추가 -->
      <div>
        <div class="sub">한 줄에 하나씩 <b>트윗 URL</b>. 같은 줄에 <code>#태그</code>와 <code>| 메모</code> 가능. 아래 “공통 태그”는 이번 추가분 전체에 붙습니다.</div>
        <textarea id="bulk" placeholder="예)
https://twitter.com/nasa/status/123... #우주 #사진 | 허블 텍스트
https://x.com/someone/status/456... #정책 | 개인 메모"></textarea>
        <div class="controls" style="margin-top:8px">
          <input id="commonTags" placeholder="공통 태그 (예: #읽을거리 #디자인)" />
          <button id="importBtn">가져오기</button>
          <button id="clearInput">입력창 비우기</button>
          <button id="syncSettings">동기화 설정</button>
          <span class="sub">중복 URL은 자동 건너뜁니다.</span>
        </div>
      </div>
      <!-- 우: 검색/동기화/배치 -->
      <div>
        <div class="sub">검색( URL / #태그 / 메모 )</div>
        <input id="q" placeholder="#우주 또는 메모 단어 등" />
        <div class="controls" style="margin-top:8px">
          <label class="switch"><input type="checkbox" id="darkToggle" /> 다크모드</label>
          <span class="count sub" id="count"></span>
        </div>
        <div class="controls" style="margin-top:6px">
          <button id="cloudPull">클라우드에서 불러오기</button>
          <button id="cloudPush">클라우드로 업로드</button>
          <button id="exportBtn">백업 내보내기(JSON)</button>
          <button id="importJsonBtn">백업 불러오기</button>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
        </div>

        <!-- 페이지 모드일 때만 보이는 페이지네이션 -->
        <div class="controls pager" id="pagerBar" style="margin-top:6px">
          <div class="sub">페이지 크기</div>
          <select id="pageSize">
            <option>6</option><option>9</option><option selected>12</option><option>18</option><option>24</option><option>36</option>
          </select>
          <button id="firstPage">« 처음</button>
          <button id="prevPage">‹ 이전</button>
          <span class="info" id="pageInfo">1 / 1</span>
          <button id="nextPage">다음 ›</button>
          <button id="lastPage">마지막 »</button>
        </div>

        <!-- 더 보기 전용 컨트롤 -->
        <div class="controls" id="loadMoreBar" style="margin-top:6px;display:none">
          <div class="sub">배치 크기</div>
          <select id="batchSize">
            <option>6</option><option>9</option><option selected>12</option><option>18</option><option>24</option><option>36</option>
          </select>
          <button id="loadMore">더 보기</button>
          <span class="sub" id="moreInfo"></span>
        </div>
      </div>
    </div>

    <!-- 태그 필터/정렬 -->
    <div class="controls" id="filterRow" style="margin-top:6px">
      <button id="tagFilterBtn">태그 필터</button>
      <button id="viewAllBtn">전체보기</button>
      <button id="untaggedBtn">무태그</button>
      <span class="sub" id="tagFilterLabel">전체</span>
      <span class="count sub" id="count2" style="margin-left:auto"></span>
      <label class="sub" style="margin-left:8px">정렬</label>
      <select id="sortBy">
        <option value="addedDesc" selected>최신 등록순</option>
        <option value="addedAsc">오래된순</option>
      </select>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="grid"></div>
    <div id="sentinel" style="height:1px"></div>
  </div>
</main>

<!-- 우하단 고정: '도구' (전역 폴백 포함) -->
<button
  id="headerQuickToggle"
  class="quick-toggle"
  aria-expanded="false"
  title="도구"
  onclick="window.__toggleHeader && window.__toggleHeader()"
>도구</button>

<!-- 동기화 모달 -->
<div class="modal-backdrop" id="modalWrap" style="display:none">
  <div class="modal">
    <h2>동기화 설정</h2>
    <div class="desc">GitHub 토큰(권한: gist read/write)과 비공개 Gist의 ID를 입력하세요. 이 값들은 이 브라우저에만 저장됩니다.</div>
    <div class="row">
      <div><label class="sub">GitHub Personal Access Token</label><input id="tokenInput" placeholder="ghp_... 또는 fine-grained token" /></div>
      <div><label class="sub">Gist ID</label><input id="gistInput" placeholder="예: abcdef1234567890..." /></div>
      <div class="controls" style="margin-top:10px">
        <button id="saveSettings" style="border-color:var(--accent);color:var(--accent)">저장</button>
        <button id="closeSettings">닫기</button>
        <span class="sub" id="settingsStatus"></span>
      </div>
    </div>
  </div>
</div>

<!-- 태그 선택 모달 -->
<div class="modal-backdrop" id="tagModal" style="display:none">
  <div class="modal">
    <h2>태그 필터</h2>
    <div class="desc">여러 태그를 고르고 AND/OR를 선택하세요. “무태그만”은 태그가 없는 항목만.</div>

    <div class="tag-toolbar">
      <input id="tagSearch" placeholder="태그 검색 (예: #우주)" style="flex:1" />
      <label class="switch">매칭
        <select id="tagMatch">
          <option value="AND">AND(모두 포함)</option>
          <option value="OR" selected>OR(하나 이상)</option>
        </select>
      </label>
      <label class="switch"><input type="checkbox" id="onlyUntagged"> 무태그만</label>
    </div>

    <div class="tag-list" id="tagList"></div>

    <div class="controls" style="margin-top:10px; justify-content:space-between">
      <div>
        <button id="tagSelectAll">전체 선택</button>
        <button id="tagClearAll">전체 해제</button>
        <button id="tagReset">필터 초기화</button>
      </div>
      <div>
        <button id="tagApply">적용</button>
        <button id="tagCloseBtn">닫기</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 유틸 & 상태 ===== */
const $=(s,d=document)=>d.querySelector(s);
const $$=(s,d=document)=>Array.from(d.querySelectorAll(s));
const LS_KEY='tweet-shelf-v9';
const CFG_TOKEN='tweet-shelf-token';
const CFG_GIST='tweet-shelf-gist';
const LS_THEME='theme';
const LS_SORT='tweet-shelf-sort';

const debounce=(fn,ms=600)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
const normalize=(url)=>{try{const u=new URL(url.trim());if(u.hostname==='x.com')u.hostname='twitter.com';return u.toString()}catch{return url.trim()}};
const parseLine=(line)=>{
  const urlMatch=line.match(/https?:\/\/(twitter\.com|x\.com)\/\S+/i); if(!urlMatch) return null;
  const url=normalize(urlMatch[0]);
  const tags=(line.match(/#[^\s#|]+/g)||[]).map(s=>s.toLowerCase());
  const note=line.includes('|')?line.split('|').slice(1).join('|').trim():'';
  return { url, tags, note };
};
const loadLocal=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{return[]}};
const saveLocal=(arr)=>localStorage.setItem(LS_KEY, JSON.stringify(arr));

const state={
  items: loadLocal(),
  theme: localStorage.getItem(LS_THEME) || 'light',
  token: localStorage.getItem(CFG_TOKEN) || '',
  gistId: localStorage.getItem(CFG_GIST) || '',
  activeTags: [],
  tagMatch: 'OR',
  onlyUntagged: false,
  // 뷰 모드
  mode: 'paginate',      // 'paginate' | 'loadMore' | 'infinite'
  page: 1,
  pageSize: 12,
  batch: 12,             // loadMore 모드에서 사용
  offset: 0,             // loadMore/infinite 에서 누적표시
  ioLoad: null,
  MAX_MOUNTED: 30,
  sortBy: localStorage.getItem(LS_SORT) || 'addedDesc'
};

/* ===== 테마 & 마이그레이션 ===== */
function applyTheme(){ document.documentElement.setAttribute('data-theme', state.theme); $('#darkToggle').checked = state.theme==='dark'; }
function migrateAddedAt(){
  const now=Date.now(); let changed=false;
  state.items.forEach((it,i)=>{ if(typeof it.addedAt!=='number'){ it.addedAt=now-i; changed=true; } });
  if(changed) saveLocal(state.items);
}

/* ===== 필터 & 정렬 ===== */
function currentFiltered(){
  const q=($('#q')?.value||'').toLowerCase().trim();
  const tagsSel = state.activeTags;
  const mode = state.tagMatch;
  const onlyUntagged = state.onlyUntagged;

  return state.items.filter(it=>{
    const itemTags = (it.tags||[]).map(t=>t.toLowerCase());
    const hay = [it.url, itemTags.join(' '), it.note||''].join(' ').toLowerCase();

    if (q && !hay.includes(q)) return false;
    if (onlyUntagged) return itemTags.length===0;

    if (tagsSel.length>0){
      if (mode==='AND'){
        if (!tagsSel.every(t=>itemTags.includes(t))) return false;
      } else {
        if (!tagsSel.some(t=>itemTags.includes(t))) return false;
      }
    }
    return true;
  });
}
function sortItems(arr){
  const by=state.sortBy;
  if(by==='addedDesc') return arr.slice().sort((a,b)=>(b.addedAt||0)-(a.addedAt||0));
  if(by==='addedAsc')  return arr.slice().sort((a,b)=>(a.addedAt||0)-(b.addedAt||0));
  return arr;
}

/* ===== 카드 ===== */
function cardHTML(item){
  const tagText=(item.tags||[]).join(' ');
  const placeholder = `<div class="placeholder">임베드 안 함 · [보기]로 표시</div>`;
  return `
    <article class="card" data-id="${item.url}" data-url="${item.url}"
             data-tags="${tagText}" data-note="${item.note||''}" data-embedded="0">
      <div class="meta"><span>${tagText || '태그 없음'}</span>${item.note?`<span>· ${item.note}</span>`:''}</div>
      <div class="embed">${placeholder}</div>
      <div class="line">
        <input class="tags" placeholder="#태그 공백구분" value="${tagText}" />
        <button class="view">보기</button>
      </div>
      <div class="line"><input class="note" placeholder="메모" value="${item.note||''}" /></div>
      <div class="footer">
        <a class="link" href="${item.url}" target="_blank" rel="noopener">${item.url}</a>
        <div class="actions"><button class="del">삭제</button></div>
      </div>
    </article>`;
}
function bindCardEvents(slice){
  slice.forEach(item=>{
    const card=document.querySelector(`.card[data-id="${CSS.escape(item.url)}"]`);
    if(!card) return;
    card.querySelector('.view').addEventListener('click', ()=> ensureEmbed(card));
    card.querySelector('.del').addEventListener('click', ()=>{
      const idx=state.items.findIndex(x=>x.url===item.url);
      if(idx===-1) return;
      if(!confirm('이 카드를 삭제할까요?')) return;
      state.items.splice(idx,1); saveLocal(state.items);
      card.remove(); updateCounters(); renderAfterDelete();
    });
    const tagsInput=card.querySelector('.tags');
    const noteInput=card.querySelector('.note');
    const doSave=debounce(()=>{
      const idx=state.items.findIndex(x=>x.url===item.url); if(idx===-1) return;
      const tags=tagsInput.value.trim().split(/\s+/).filter(Boolean).map(s=>s.startsWith('#')?s.toLowerCase():'#'+s.toLowerCase());
      const note=noteInput.value.trim();
      state.items[idx].tags=tags; state.items[idx].note=note; saveLocal(state.items);
      card.dataset.tags=tags.join(' '); card.dataset.note=note;
      card.querySelector('.meta').innerHTML=`<span>${card.dataset.tags || '태그 없음'}</span>${note?`<span>· ${note}</span>`:''}`;
    }, 600);
    tagsInput.addEventListener('input', doSave);
    noteInput.addEventListener('input', doSave);
  });
}

/* ===== 임베드 ===== */
function tweetIdFromUrl(url){ const m=url.match(/status\/(\d+)/); return m?m[1]:null; }
function ensureEmbed(card){
  if(card.dataset.embedded==='1') return;
  const url=card.dataset.url; const id=tweetIdFromUrl(url); const mount=card.querySelector('.embed');
  if(!mount) return;
  mount.innerHTML='';
  if(window.twttr && window.twttr.widgets && id){
    window.twttr.widgets.createTweet(id, mount); card.dataset.embedded='1';
  } else {
    mount.innerHTML=`<blockquote class="twitter-tweet"><a href="${url}"></a></blockquote>`;
    if(window.twttr&&window.twttr.widgets) window.twttr.widgets.load(mount);
    card.dataset.embedded='1';
  }
}
async function embedQueue(cards, concurrency){
  const total=cards.length; let done=0, running=0, index=0; const statusEl=$('#embedStatus');
  const upd=()=>{ if(statusEl) statusEl.textContent= total ? `임베드 진행: ${done}/${total}` : ''; };
  upd();
  return new Promise(resolve=>{
    const launch=()=>{
      if(done===total){ upd(); resolve(); return; }
      while(running<concurrency && index<total){
        const c=cards[index++]; running++;
        try{ ensureEmbed(c); }catch(e){ console.warn('embed error',e); }
        finally{ done++; running--; upd(); setTimeout(launch,0); }
      }
    };
    launch();
  });
}

/* ===== 공통 렌더 헬퍼 ===== */
function updateCounters(){
  const total = sortItems(currentFiltered()).length;
  const shown = $('#grid').children.length;
  $('#count').textContent = `총 ${total}개 · ${shown}/${total}`;
  $('#count2').textContent = `총 ${total}개 · ${shown}/${total}`;
}

/* ===== 페이지 모드 ===== */
function pageStats(){
  const filtered=sortItems(currentFiltered());
  const total=filtered.length;
  const totalPages=Math.max(1, Math.ceil(total / state.pageSize));
  const page=Math.min(state.page, totalPages);
  return { filtered, total, totalPages, page };
}
function renderPage(){
  const { filtered, totalPages, page } = pageStats();
  state.page = page;
  $('#grid').innerHTML='';
  const start=(page-1)*state.pageSize;
  const slice=filtered.slice(start, start+state.pageSize);
  if(slice.length){
    $('#grid').insertAdjacentHTML('beforeend', slice.map(cardHTML).join(''));
    bindCardEvents(slice);
    const cards = Array.from(document.querySelectorAll('.card'));
    embedQueue(cards, Math.max(1, Math.min(8, +$('#embedConcurrency').value || 4)));
  }
  $('#pageInfo').textContent = `${page} / ${totalPages}`;
  $('#firstPage').disabled = (page<=1);
  $('#prevPage').disabled  = (page<=1);
  $('#nextPage').disabled  = (page>=totalPages);
  $('#lastPage').disabled  = (page>=totalPages);
  updateCounters();
}
function renderAfterDelete(){
  if(state.mode!=='paginate') return;
  const { totalPages, page } = pageStats();
  if(page>totalPages) state.page = totalPages;
  renderPage();
}

/* ===== 더보기 모드 ===== */
function appendBatch(filtered){
  const start=state.offset;
  const slice=filtered.slice(start, start+state.batch);
  if(!slice.length) return 0;
  $('#grid').insertAdjacentHTML('beforeend', slice.map(cardHTML).join(''));
  bindCardEvents(slice);
  state.offset += slice.length;
  updateCounters();
  return slice.length;
}
async function onLoadMoreClick(){
  if(state.mode!=='loadMore') return;
  const filtered=sortItems(currentFiltered());
  const added = appendBatch(filtered);
  if(!added){ $('#moreInfo').textContent='끝까지 표시되었습니다.'; return; }
  const cards = Array.from(document.querySelectorAll('.card')).slice(-added);
  const c = Math.max(1, Math.min(8, +$('#embedConcurrency').value || 4));
  await embedQueue(cards, c);
}

/* ===== 무한 스크롤 ===== */
function setupInfiniteObserver(){
  if(state.ioLoad){ state.ioLoad.disconnect(); state.ioLoad=null; }
  state.ioLoad = new IntersectionObserver(async entries=>{
    if(!entries[0].isIntersecting) return;
    if(state.mode!=='infinite') return;
    const filtered=sortItems(currentFiltered());
    const added = appendBatch(filtered);
    if(added){
      const newCards = Array.from(document.querySelectorAll('.card')).slice(-added);
      const c = Math.max(1, Math.min(8, +$('#embedConcurrency').value || 4));
      await embedQueue(newCards, c);
      windowingTrim();
    }
  }, {root:null, rootMargin:'200px'});
  state.ioLoad.observe($('#sentinel'));
}
function windowingTrim(){
  const cards = Array.from(document.querySelectorAll('.card'));
  if(cards.length <= state.MAX_MOUNTED) return;
  const removeCount = cards.length - state.MAX_MOUNTED;
  for(let i=0;i<removeCount;i++){
    const card=cards[i]; const mount=card.querySelector('.embed');
    if(mount){ mount.innerHTML='<div class="placeholder">임베드 해제됨</div>'; }
    card.dataset.embedded='0';
  }
}

/* ===== 태그 모달 ===== */
function openTagModal(){
  const modal=$('#tagModal'), listWrap=$('#tagList'), search=$('#tagSearch');
  const matchSel=$('#tagMatch'), onlyUntagged=$('#onlyUntagged');
  if(!modal||!listWrap||!search||!matchSel||!onlyUntagged) return;

  let selected = new Set(state.activeTags);
  let tempMatch = state.tagMatch;
  let tempOnlyUntagged = state.onlyUntagged;

  const counts=new Map();
  state.items.forEach(it => (it.tags||[]).forEach(t => counts.set(t.toLowerCase(), (counts.get(t.toLowerCase())||0)+1)));
  const tags=Array.from(counts.entries()).sort((a,b)=>a[0].localeCompare(b[0]));

  function renderList(filter=''){
    const f=filter.toLowerCase().trim(); listWrap.innerHTML='';
    tags.forEach(([name,count])=>{
      if(f && !name.toLowerCase().includes(f)) return;
      const row=document.createElement('label'); row.className='tag-item';
      row.innerHTML=`
        <div>
          <input type="checkbox" ${selected.has(name)?'checked':''} />
          <span class="tag-name">${name}</span>
        </div>
        <span class="tag-count">${count}개</span>`;
      row.querySelector('input').addEventListener('change',(e)=>{
        if(e.target.checked) selected.add(name); else selected.delete(name);
      });
      listWrap.appendChild(row);
    });
  }

  matchSel.value=tempMatch; onlyUntagged.checked=tempOnlyUntagged;
  search.value=''; renderList('');

  matchSel.onchange=(e)=> tempMatch=e.target.value;
  onlyUntagged.onchange=(e)=> tempOnlyUntagged=!!e.target.checked;
  search.oninput=(e)=> renderList(e.target.value);

  $('#tagSelectAll').onclick=()=>{ selected=new Set(tags.map(t=>t[0])); renderList(search.value); };
  $('#tagClearAll').onclick=()=>{ selected=new Set(); renderList(search.value); };
  $('#tagReset').onclick=()=>{ selected=new Set(); tempMatch='OR'; tempOnlyUntagged=false; matchSel.value='OR'; onlyUntagged.checked=false; renderList(''); search.value=''; };

  $('#tagApply').onclick=()=>{
    state.activeTags=Array.from(selected);
    state.tagMatch=tempMatch;
    state.onlyUntagged=tempOnlyUntagged;
    updateTagFilterLabel();
    close(); refreshView();
  };
  $('#tagCloseBtn').onclick=close;
  modal.addEventListener('click',(e)=>{ if(e.target && e.target.id==='tagModal') close(); });
  function close(){ modal.style.display='none'; }
  modal.style.display='flex';
}
function updateTagFilterLabel(){
  const el=$('#tagFilterLabel'); if(!el) return;
  const tags=state.activeTags, mode=state.tagMatch;
  if(state.onlyUntagged){ el.textContent='무태그만'; return; }
  if(!tags.length){ el.textContent='전체'; }
  else{ const short=tags.slice(0,3).join(' '); el.textContent=`${short}${tags.length>3?' …':''} · ${mode}`; }
}

/* ===== 헤더 자동접힘 + 오버레이 토글(강화판) ===== */
(function headerToggle(){
  function init(){
    const header=$('header'), btn=$('#headerQuickToggle');
    if(!header||!btn) return;
    header.classList.add('auto-hide');

    function updateHeaderMax(){
      const prev=header.style.maxHeight; header.style.maxHeight='none';
      const h=header.scrollHeight; header.style.maxHeight=prev;
      header.style.setProperty('--header-max', h+'px');
    }
    const ro=new ResizeObserver(updateHeaderMax);
    ro.observe(header); window.addEventListener('resize', updateHeaderMax);
    requestAnimationFrame(updateHeaderMax); window.addEventListener('load', updateHeaderMax);

    function showHeader(){
      header.classList.remove('hide'); btn.setAttribute('aria-expanded','true'); updateHeaderMax();
    }
    function hideHeader(){
      header.classList.add('hide'); btn.setAttribute('aria-expanded','false'); header.classList.remove('overlay');
    }

    // 항상 어디서든 열리도록: 오버레이 강제 + 가시성 폴백
    function openOverlay(){
      header.classList.add('overlay');
      showHeader();
      // 다음 프레임에서 가시성 확인 → 필요 시 폴백 스크롤
      setTimeout(()=>{
        const rect = header.getBoundingClientRect();
        if(rect.height < 10 || rect.bottom <= 0 || rect.top < -5){
          // 드물게 레이아웃 지연 시 맨 위로 스크롤 폴백
          window.scrollTo({ top: 0, behavior: 'smooth' });
          setTimeout(()=>{ header.classList.add('overlay'); showHeader(); }, 280);
        }
      }, 60);
    }

    // 전역 토글
    window.__toggleHeader = function(){
      // 열려 있으면 닫기
      if(!header.classList.contains('hide')){ hideHeader(); return; }
      // 접혀 있으면 오버레이로 열기
      openOverlay();
    };
    // 구버전 호환
    window.__toggleTools = window.__toggleHeader;

    // 초기 상태
    if(window.scrollY<=0) showHeader(); else hideHeader();

    // 스크롤: 아래로 내리면 접힘 / 맨 위면 펼침 (오버레이 중에는 유지)
    let lastY=window.scrollY, ticking=false;
    const DOWN_DELTA=8, HIDE_START=1;
    function onScroll(){
      if(ticking) return; ticking=true;
      requestAnimationFrame(()=>{
        const y=window.scrollY, dy=y-lastY;
        if(header.classList.contains('overlay')){
          // 오버레이 열려있으면 자동 접힘 방지
        }else{
          if(y<=0){ showHeader(); }
          else if(dy>DOWN_DELTA && y>HIDE_START){ hideHeader(); }
        }
        lastY=y; ticking=false;
      });
    }
    window.addEventListener('scroll', onScroll, {passive:true});

    // 버튼 이벤트(인라인 onclick도 있지만 안전하게 한 번 더 바인딩)
    btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); window.__toggleHeader(); }, {passive:false});
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();

/* ===== 초기화 & 이벤트 ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  migrateAddedAt();

  // 테마
  applyTheme();
  $('#darkToggle').addEventListener('change', e=>{ state.theme=e.target.checked?'dark':'light'; localStorage.setItem(LS_THEME,state.theme); applyTheme(); });

  // 모드 전환
  const toPaginate=()=>{ state.mode='paginate'; $('#pagerBar').style.display='flex'; $('#loadMoreBar').style.display='none'; refreshView(); };
  const toLoadMore=()=>{ state.mode='loadMore'; $('#pagerBar').style.display='none'; $('#loadMoreBar').style.display='flex'; state.offset=0; $('#grid').innerHTML=''; refreshView(); };
  const toInfinite=()=>{ state.mode='infinite'; $('#pagerBar').style.display='none'; $('#loadMoreBar').style.display='none'; state.offset=0; $('#grid').innerHTML=''; refreshView(); };
  $('#modePaginate').addEventListener('change', toPaginate);
  $('#modeLoadMore').addEventListener('change', toLoadMore);
  $('#modeInfinite').addEventListener('change', toInfinite);

  // 페이지 크기 / 배치 크기
  $('#pageSize').value=String(state.pageSize);
  $('#pageSize').addEventListener('change', e=>{ state.pageSize=+e.target.value; state.page=1; refreshView(); });
  $('#batchSize').value=String(state.batch);
  $('#batchSize').addEventListener('change', e=>{ state.batch=+e.target.value; state.offset=0; refreshView(); });

  // 페이지 이동
  $('#firstPage').addEventListener('click', ()=>{ state.page=1; renderPage(); });
  $('#prevPage').addEventListener('click', ()=>{ state.page=Math.max(1,state.page-1); renderPage(); });
  $('#nextPage').addEventListener('click', ()=>{ const {totalPages}=pageStats(); state.page=Math.min(totalPages,state.page+1); renderPage(); });
  $('#lastPage').addEventListener('click', ()=>{ const {totalPages}=pageStats(); state.page=totalPages; renderPage(); });

  // 검색 / 정렬
  $('#q').addEventListener('input', ()=>{ state.page=1; refreshView(); });
  $('#sortBy').value = state.sortBy;
  $('#sortBy').addEventListener('change', (e)=>{ state.sortBy=e.target.value; localStorage.setItem(LS_SORT,state.sortBy); state.page=1; refreshView(); });

  // 태그 모달 버튼
  $('#tagFilterBtn').addEventListener('click', openTagModal);
  updateTagFilterLabel();

  // 메인 빠른 필터 버튼
  $('#viewAllBtn').addEventListener('click', ()=>{
    state.activeTags=[]; state.onlyUntagged=false; updateTagFilterLabel(); state.page=1; refreshView();
  });
  $('#untaggedBtn').addEventListener('click', ()=>{
    state.activeTags=[]; state.onlyUntagged=true; updateTagFilterLabel(); state.page=1; refreshView();
  });

  // === 동기화 설정 (모달) ===
  const modalWrap = $('#modalWrap');
  const tokenInput = $('#tokenInput');
  const gistInput  = $('#gistInput');
  const settingsStatus = $('#settingsStatus');

  function openSyncModal(){
    tokenInput.value = state.token || '';
    gistInput.value  = state.gistId || '';
    settingsStatus.textContent = (state.token && state.gistId)
      ? '현재 저장된 값이 불러와졌습니다.'
      : '토큰과 Gist ID를 입력하세요.';
    modalWrap.style.display='flex';
  }
  function closeSyncModal(){ modalWrap.style.display='none'; }
  function saveSyncSettings(){
    const token = (tokenInput?.value || '').trim();
    const gist  = (gistInput?.value  || '').trim();
    if(!token || !gist){
      settingsStatus.textContent = '둘 다 입력해야 저장됩니다.';
      return;
    }
    state.token = token;
    state.gistId = gist;
    localStorage.setItem(CFG_TOKEN, token);
    localStorage.setItem(CFG_GIST, gist);
    settingsStatus.textContent = '저장 완료. 이제 동기화 버튼을 사용할 수 있어요.';
    setTimeout(closeSyncModal, 500);
  }
  $('#syncSettings').addEventListener('click', openSyncModal);
  $('#saveSettings').addEventListener('click', saveSyncSettings);
  $('#closeSettings').addEventListener('click', closeSyncModal);
  modalWrap.addEventListener('click', (e)=>{ if(e.target===modalWrap) closeSyncModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modalWrap.style.display==='flex'){ closeSyncModal(); }});

  // 가져오기
  $('#importBtn').addEventListener('click', ()=>{
    const lines=$('#bulk').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const common=($('#commonTags').value||'').trim().split(/\s+/).filter(Boolean).map(t=>t.startsWith('#')?t.toLowerCase():'#'+t.toLowerCase());
    const newOnes=[];
    for(const line of lines){
      const p=parseLine(line); if(!p) continue;
      if(state.items.some(x=>x.url===p.url)) continue;
      p.addedAt=Date.now();
      if(common.length) p.tags=[...new Set([...(p.tags||[]), ...common])];
      newOnes.push(p);
    }
    if(!newOnes.length){ alert('추가할 URL이 없습니다.'); return; }
    state.items=[...newOnes, ...state.items];
    saveLocal(state.items);
    $('#bulk').value=''; state.page=1; refreshView();
  });
  $('#clearInput').addEventListener('click', ()=> $('#bulk').value='');

  // 더 보기
  $('#loadMore').addEventListener('click', onLoadMoreClick);

  // 임베드 일괄
  $('#embedAll').addEventListener('click', async ()=>{
    const vis = Array.from(document.querySelectorAll('.card')).filter(c=>c.offsetParent!==null);
    const c = Math.max(1, Math.min(8, +$('#embedConcurrency').value || 4));
    await embedQueue(vis, c);
  });

  // 백업/복원
  $('#exportBtn').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state.items,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tweet-shelf-backup.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#importJsonBtn').addEventListener('click', ()=> $('#fileInput').click());
  $('#fileInput').addEventListener('change', (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const arr=JSON.parse(r.result); if(!Array.isArray(arr)) throw new Error();
        const cleaned=arr.filter(x=>x && typeof x.url==='string').map(x=>({
          url:normalize(x.url),
          tags:Array.isArray(x.tags)?x.tags.map(t=>t.toLowerCase()):[],
          note: typeof x.note==='string'?x.note:'',
          addedAt: typeof x.addedAt==='number' ? x.addedAt : Date.now()
        }));
        state.items=cleaned; saveLocal(state.items); state.page=1; refreshView();
      }catch{ alert('JSON 형식이 올바르지 않습니다.'); }
    };
    r.readAsText(f,'utf-8'); e.target.value='';
  });

  // 동기화(Gist)
  async function cloudPull(){
    if(!state.token || !state.gistId){ alert('동기화 설정이 비어있습니다.'); return; }
    const res=await fetch(`https://api.github.com/gists/${state.gistId}`,{
      headers:{'Authorization':`Bearer ${state.token}`,'Accept':'application/vnd.github+json'}
    });
    if(!res.ok){ alert('불러오기 실패: Gist ID/토큰 확인'); return; }
    const data=await res.json();
    const file=Object.values(data.files||{}).find(f=>/tweet-shelf\.json$/i.test(f.filename));
    if(!file){ alert('Gist에 tweet-shelf.json 파일이 없습니다.'); return; }
    try{
      const arr=JSON.parse(file.content); if(!Array.isArray(arr)) throw new Error();
      const map=new Map();
      arr.forEach(x=>{
        const item={ url:normalize(x.url), tags:(x.tags||[]).map(t=>t.toLowerCase()), note:x.note||'', addedAt: typeof x.addedAt==='number'?x.addedAt:Date.now() };
        map.set(item.url,item);
      });
      state.items.forEach(x=>{ if(!map.has(x.url)) map.set(x.url,x); });
      state.items=Array.from(map.values());
      saveLocal(state.items);
      state.page=1; refreshView();
      alert('클라우드에서 불러왔습니다.');
    }catch{ alert('Gist JSON 파싱 실패'); }
  }
  async function cloudPush(){
    if(!state.token || !state.gistId){ alert('동기화 설정이 비어있습니다.'); return; }
    const body={files:{'tweet-shelf.json':{content:JSON.stringify(state.items,null,2)}}};
    const res=await fetch(`https://api.github.com/gists/${state.gistId}`,{
      method:'PATCH',
      headers:{
        'Authorization':`Bearer ${state.token}`,
        'Accept':'application/vnd.github+json',
        'Content-Type':'application/json'
      },
      body:JSON.stringify(body)
    });
    if(!res.ok){ alert('업로드 실패: Gist ID/토큰/권한 확인'); return; }
    alert('클라우드로 업로드했습니다.');
  }
  $('#cloudPull').addEventListener('click', cloudPull);
  $('#cloudPush').addEventListener('click', cloudPush);

  // 초기 렌더
  refreshView();
  setupInfiniteObserver();
});

/* ===== 뷰 리프레시 ===== */
function refreshView(){
  const filtered=sortItems(currentFiltered());
  $('#count').textContent=`총 ${filtered.length}개`;
  $('#count2').textContent=`총 ${filtered.length}개`;
  $('#grid').innerHTML='';
  state.offset=0;
  if(state.mode==='paginate'){
    $('#pagerBar').style.display='flex'; $('#loadMoreBar').style.display='none';
    renderPage();
  }else if(state.mode==='loadMore'){
    $('#pagerBar').style.display='none'; $('#loadMoreBar').style.display='flex';
    const added=appendBatch(filtered);
    if(added){
      const newCards=Array.from(document.querySelectorAll('.card')).slice(-added);
      embedQueue(newCards, Math.max(1, Math.min(8, +$('#embedConcurrency').value || 4)));
    }
  }else{ // infinite
    $('#pagerBar').style.display='none'; $('#loadMoreBar').style.display='none';
    const added=appendBatch(filtered);
    if(added){
      const newCards=Array.from(document.querySelectorAll('.card')).slice(-added);
      embedQueue(newCards, Math.max(1, Math.min(8, +$('#embedConcurrency').value || 4)));
    }
  }
}
</script>
</body>
</html>
